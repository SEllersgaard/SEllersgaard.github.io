<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="qSJUmJp4-T1Lz9aVN5PqYy0RLyyLWAThSD6RTUty4S8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>The SVI Model - A Tutorial | Simon Ellersgaard Nielsen</title> <meta name="author" content="Simon Ellersgaard Nielsen"> <meta name="description" content="A Pythonesque implementation of Gatheral's volatility smile model"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://sellersgaard.github.io/blog/2023/svi/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Simon </span>Ellersgaard Nielsen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">The SVI Model - A Tutorial</h1> <p class="post-meta">November 14, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/volatility"> <i class="fas fa-hashtag fa-sm"></i> volatility</a>   <a href="/blog/tag/crypto"> <i class="fas fa-hashtag fa-sm"></i> crypto</a>   <a href="/blog/tag/options"> <i class="fas fa-hashtag fa-sm"></i> options</a>     ·   <a href="/blog/category/modelling"> <i class="fas fa-tag fa-sm"></i> modelling</a>   </p> </header> <article class="post-content"> <figure> <picture> <img src="/assets/img/krishna.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>When a smile means the world: in the Bhagavata Purana, Krishna famously gives his foster mother a glimpse of his true essence (“Vishvarupa”) in a most unusual manner. At a more pedestrian level the ‘world’ is also baked into the volatility smile which codifies the market view of the (risk neutral) distributive properties of the underlying security.</em></p> <h3 id="the-svi-model-the-theoretical-minimum">The SVI model: The theoretical minimum.</h3> <p>The Stochastic Volatility Inspired (SVI) model is a parametric equation for the volatility smile designed by <a href="https://en.wikipedia.org/wiki/Jim_Gatheral" rel="external nofollow noopener" target="_blank">Jim Gatheral</a> during his time at Merrill Lynch in the late 1990s. Several highly readable theoretical expositions exist including <a href="https://mfe.baruch.cuny.edu/wp-content/uploads/2013/01/OsakaSVI2012.pdf" rel="external nofollow noopener" target="_blank">Gatheral</a> , <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2033323" rel="external nofollow noopener" target="_blank">Gatheral and Jacquier</a>, and <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3543766" rel="external nofollow noopener" target="_blank">Ferhati</a>, which you are encouraged to consult. In this piece we provide a self-contained introduction to the subject, focussing on implementation: the theory is deliberately kept cursory. Note that I’ve only run this code ad hoc, and make no claims of it being production grade. If you find anything untoward, let me know.</p> <p>The core idea of the SVI can be summarised as follows: rather than fitting a global model of the volatility surface in “one go” the SVI model sets out to fit each smile individually (one expiry date at a time), often with careful constraints applied to ensure that all smiles preclude arbitrage. Specifically, for a given tenor \(\tau\), the SVI model postulates that the smile be modelled as</p> \[w(k,\tau) = a + b \left\{ \varrho (k-m) + \sqrt{(k-m)^2 + \sigma^2} \right\},\] <p>where \(w: \mathbb{R} \times [0,T] \mapsto \mathbb{R}^+\) is the <em>total variance</em>, defined as \(w(k,\tau) \equiv \tau \sigma_{BS}^2(k,\tau)\) (the time scaled Black Scholes implied vol <em>squared</em>) and \(k\) is the <em>log forward moneyness</em>, defined as \(\ln(K/F_\tau)\), where \(K\) and \(F_\tau\) are the strike and forward prices. For ease of notation we have suppressed the \(\tau\) dependence on the parameters \(\chi \equiv \{a,b,\varrho, m, \sigma\}\), but keep this in mind. Roughly speaking, \(a \in \mathbb{R}\) controls the overall variance level (vertical translations); \(b \in \mathbb{R}^+\) controls the slope of the wings; \(\varrho \in (-1,1)\) controls the counter-clockwise rotation of the smile; \(m \in \mathbb{R}\) the vertical translations, and \(\sigma \in \mathbb{R}^+\) the level of curvature.</p> <p>Further constraints must be enforced upon the parameters to ensure sensible results. For starters Gatheral lists the requirement that \(a+b \sigma \sqrt{1-\varrho^2} \geq 0\) for a non-negative total variance. More subtle constraints arise from eliminating arbitrage. E.g. on the intra-smile level, the absence of <em>butterfly arbitrage</em> entails that one cannot go long a <a href="https://en.wikipedia.org/wiki/Butterfly_(options)" rel="external nofollow noopener" target="_blank">fly (option structure)</a> without paying for the pleasure. (A fly has a pay-off structure which is everywhere non-negative. You don’t get this sort of optionality for free). By <a href="https://quantpy.com.au/stochastic-calculus/breeden-litzenberger-formula-for-risk-neutral-densities/" rel="external nofollow noopener" target="_blank">Breeden Litzenberger</a> this turns out to be equivalent to requiring that the risk neutral density function is everywhere non-negative (a very reasonable disposition indeed). A tedious argument shows that this amounts to requiring that \(g(k) \geq 0\), \(\forall k\) where we have defined</p> \[g(k) \equiv \left( 1-\frac{kw'(k)}{2w(k)} \right)^2 - \frac{w'(k)^2}{4} \left( \frac{1}{w(k)} + \frac{1}{4}\right) + \frac{w''(k)}{2},\] <p>… which hardly is the sort of expression you want to throw at an optimisation problem. Fortunately, based on Roger Lee’s moment formula, <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3543766" rel="external nofollow noopener" target="_blank">Ferhati</a> shows that for the SVI we can get away with requiring something considerably simpler, viz.</p> <ul> <li>\((a-mb(\varrho+1))(4-a+mb(\varrho+1)) &gt; b^2(\varrho+1)^2\).</li> <li>\((a-mb(\varrho-1))(4-a+mb(\varrho-1)) &gt; b^2(\varrho-1)^2\).</li> <li>\(0&lt;b^2(\varrho+1)^2&lt;4\).</li> <li>\(0&lt;b^2(\varrho-1)^2&lt;4\).</li> </ul> <p>In the implementation below, this is what we run with.</p> <p>Alright so the individual smiles can be made arb free, but what about when viewed collectively? It turns out that unless we require that call option prices are monotonically increasing as a function of time to maturity, the surface will also admit <em>calendar arbitrage</em>. To see this, imagine \(C(k,\tau_1) &gt; C(k,\tau_2)\) where \(\tau_1 &lt; \tau_2\), and that we sell short the first option and go long the second (a <a href="https://en.wikipedia.org/wiki/Calendar_spread" rel="external nofollow noopener" target="_blank">calendar spreads</a>), thus pocketing an initial premium. If the front option expires worthless, we have zero downside. On the other hand, should it expire in-the-money, we can cover our position by shorting the underlying at the prevailing price level: regardless of where the price ends up at \(\tau_2\) we make money (convince yourself this is the case). Altogether, this situation is indeed an arbitrage. To avoid it we can (equivalently) require that the total variance function \(w(k,\tau)\) is monotonically increasing as a function of time to maturity, \(\forall k: \partial_\tau w(k,\tau) \geq 0\), - or in graphical terms - that there are no crossed curves (smiles) in a total variance plot. Vis-à-vis the butterfly conditions above, this constraint is much less nimble. As you will see below, we fit total variance smiles sequentially starting with the nearest tenor, requiring that each new smile being fit is bounded from below by the most recently fitted smile. The drawback of this methodology is that it grants a distinct ontological privilege to the first smile in the batch: with often poor liquidity provided for ultra near-dated securities, this can potentially lead to sub-optimal calibrations.</p> <p>Altogether a volatility surface is said to be void of <a href="https://mfe.baruch.cuny.edu/wp-content/uploads/2013/04/BloombergSVI2013.pdf" rel="external nofollow noopener" target="_blank">static arbitrage</a> if it rules out both butterfly and calendar arbitrage. This is the benchmark against which all volatility models ultimately must be assessed (if the goal is simply to find the “best fit”, the <a href="https://en.wikipedia.org/wiki/Universal_approximation_theorem" rel="external nofollow noopener" target="_blank">Universal Approximation Theorem</a> suggests that a Neural Network solution will get you there in just a few lines of code).</p> <p>Before we move on to the implementation, a note on nomenclature: what exactly is ‘stochastic volatility inspired’ about the SVI model? The classical <a href="https://en.wikipedia.org/wiki/Heston_model" rel="external nofollow noopener" target="_blank">Heston model</a>, much adored by academics, is known to provide rapid arbitrage free surface calibrations, albeit at the cost of considerable inaccuracy, particularly for shorter maturities (the model only has five parameters). The neat part about the SVI model is that it converges asymptotically to the Heston model for large maturities, i.e.</p> \[\lim_{\tau \rightarrow \infty} \sigma_{\text{SVI}}^2(k) = \sigma_{\text{Heston}}^2(k), \forall k \in \mathbb{R}.\] <p>The model is therefore Heston <em>inspired</em>, but does not assume the global verisimilitude thereof. By having five parameters <em>per smile</em> as opposed to <em>per surface</em> we can unsurprisingly model the volatility surface with considerably greater accuracy.</p> <h3 id="coding-it-up">Coding it up</h3> <p>In the code snippet below I provide a Python implementation of the SVI model. The class takes as its input a pandas dataframe containing the volatility surface on tabular form. The frame must as a minimum contain the following five columns: the implied volatility (‘IV’) in percentage terms: (float), the strike price (‘Strike’): (float), the expiry date (‘Date’): (pd.Timestamp) the time to maturity (‘Tau’) in years: (float), and the forward price (‘F’): (float). As with all numerical routines, make sure you put in the proper amount of data cleaning effort: restricting the space of options to highly liquid ones: out-of-the-money puts and calls with absolute deltas greater than 0.05 is probably a good place to start.</p> <p>The model is calibrated using the .fit method. For a given maturity \(\tau\) this is achieved by minimising the quadratic cost function</p> \[\mathfrak{L}(\chi, \tau) = \sum_{i \in \mathbb{S}_\tau} (w_{SVI}(k_i, \tau) - w_{obs}(k_i, \tau))^2,\] <p>where \(\mathbb{S}_\tau\) is the set of coordinates making up a given smile. Smiles are fit in the ordered fashion \(\tau_1 &lt; \tau_2 &lt; ... &lt; \tau_n\), and we deploy SciPy’s implementation of the <a href="https://docs.scipy.org/doc/scipy/tutorial/optimize.html#sequential-least-squares-programming-slsqp-algorithm-method-slsqp" rel="external nofollow noopener" target="_blank">Sequantial Least SQuares Programming (SLSQP) algorithm</a> to handle the no-arbitrage constraints. To speed up the rate of convergence, I supply the minimiser with the gradient (Jacobian) of the objective function as well as the constraints: tedious expressions, provided in the various _jac functions below.</p> <p>Although not used for calibration purposes, the code also includes the risk neutral density function</p> \[q(k) = \frac{g(k)}{\sqrt{2\pi w(k)}} \exp \left \{ \frac{d_{-}^2}{2} \right \},\] <p>where \(d_{-} \equiv -k/\sqrt{w} - \sqrt{w}/2\). The class can thus readily be amended for pricing purposes.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Bounds</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="k">class</span> <span class="nc">SVIModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    This class fits Gatheral</span><span class="sh">'</span><span class="s">s Stochastic Volatility Inspired (SVI) model to a pandas dataframe of 
    implied volatility data. The pandas dataframe must contain the following columns: 
    
    i. The implied volatility (</span><span class="sh">'</span><span class="s">IV</span><span class="sh">'</span><span class="s">) in %: (float64)
    ii. The strike price (</span><span class="sh">'</span><span class="s">Strike</span><span class="sh">'</span><span class="s">): (float64)
    iii. The expiry date (</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="s">): (pd.Timestamp)
    iv. The time to maturity (</span><span class="sh">'</span><span class="s">Tau</span><span class="sh">'</span><span class="s">) in years: (float64)
    v. The forward price (</span><span class="sh">'</span><span class="s">F</span><span class="sh">'</span><span class="s">): (float64)
    
    The vol surface is fit smile-by-smile using a Sequential Least SQuares Programming optimizer which has
    the option of preventing static arbitrage (butterfly and calendar arbitrage).
    To perform the calibration, call the fit method.
    The calibrated parameters are saved in the dictionary </span><span class="sh">'</span><span class="s">param_dic</span><span class="sh">'</span><span class="s">, but can also be returned as a pandas dataframe.
    
    Simon Ellersgaard Nielsen, 2023-11-12
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">min_fit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        df: Volatility dataframe. Must contain [</span><span class="sh">'</span><span class="s">IV</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Strike</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Tau</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">F</span><span class="sh">'</span><span class="s">]
        min_fit: The minimum number of observations per smile required.
        </span><span class="sh">"""</span>
        
        <span class="k">assert</span> <span class="nf">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span>
        <span class="k">assert</span> <span class="sh">'</span><span class="s">IV</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="sh">'</span><span class="s">Strike</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="sh">'</span><span class="s">Date</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="sh">'</span><span class="s">Tau</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="sh">'</span><span class="s">F</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
        
        <span class="n">dfv</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        
        <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">TV</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Tau</span><span class="sh">'</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">IV</span><span class="sh">'</span><span class="p">]</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dfvs</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">IV</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">()</span> 
        <span class="n">dfvs</span> <span class="o">=</span> <span class="n">dfvs</span><span class="p">[</span><span class="n">dfvs</span><span class="o">&gt;=</span><span class="n">min_fit</span><span class="p">]</span>
        <span class="n">dfv</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">[</span><span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">dfvs</span><span class="p">.</span><span class="n">index</span><span class="p">)]</span>
        
        <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">LogM</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Strike</span><span class="sh">'</span><span class="p">]</span><span class="o">/</span><span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">F</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">dfv</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">([</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Strike</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Tau</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">F</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">dfv_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">dfv</span><span class="p">[</span><span class="n">dfv</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">T</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lbl</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ρ</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">σ</span><span class="sh">'</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">no_butterfly</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_calendar</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plotsvi</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Fits SVI model smile-by-smile to the data. If no no-arbitrage constraints are enforced the curves are fit using
        SciPys curve_fit. If no-arbitrage is required we use SciPy</span><span class="sh">'</span><span class="s">s sequential least squares minimization.
        </span><span class="sh">"""</span>
        
        <span class="n">ϵ</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">bnd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">'</span><span class="s">bnd</span><span class="sh">'</span><span class="p">,</span> <span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">ϵ</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">ϵ</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">]))</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">'</span><span class="s">p0</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">])</span>       
        <span class="n">self</span><span class="p">.</span><span class="n">no_butterfly</span> <span class="o">=</span> <span class="n">no_butterfly</span>
        <span class="n">self</span><span class="p">.</span><span class="n">no_calendar</span> <span class="o">=</span> <span class="n">no_calendar</span>
        
        <span class="c1"># Loop over the individual smiles
</span>        <span class="n">self</span><span class="p">.</span><span class="n">param_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">T</span><span class="p">):</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">ti</span> <span class="o">=</span> <span class="n">ti</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dfv_dic</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="sh">'</span><span class="s">LogM</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dfv_dic</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="sh">'</span><span class="s">TV</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">no_butterfly</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_calendar</span><span class="p">):</span>
                <span class="n">maxfev</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">'</span><span class="s">maxfev</span><span class="sh">'</span><span class="p">,</span><span class="mf">1e6</span><span class="p">)</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">curve_fit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">svi</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">svi_jac</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span>  <span class="n">bounds</span><span class="o">=</span><span class="n">bnd</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ineq_cons</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_no_arbitrage</span><span class="p">()</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="sh">'</span><span class="s">tol</span><span class="sh">'</span><span class="p">,</span> <span class="mf">1e-50</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nf">minimize</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">svi_mse</span><span class="p">,</span> 
                               <span class="n">p0</span><span class="p">,</span> 
                               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ydata</span><span class="p">),</span> 
                               <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">SLSQP</span><span class="sh">'</span><span class="p">,</span> 
                               <span class="n">jac</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">svi_mse_jac</span><span class="p">,</span>
                               <span class="n">constraints</span><span class="o">=</span><span class="n">ineq_cons</span><span class="p">,</span>  
                               <span class="n">bounds</span><span class="o">=</span><span class="nc">Bounds</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                               <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                               <span class="n">options</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">x</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">param_dic</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">lbl</span><span class="p">,</span> <span class="n">popt</span><span class="p">))</span> 
    
            <span class="k">if</span> <span class="n">plotsvi</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">ydata</span><span class="p">)</span>
                <span class="n">yest</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">yest</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">param_dic</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_no_arbitrage</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        No arbitrage constraints on the SVI fit
        </span><span class="sh">"""</span>
        
        <span class="n">ineq_cons</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">no_butterfly</span><span class="p">:</span>  
            <span class="n">ineq_cons</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ineq</span><span class="sh">'</span><span class="p">,</span>
                 <span class="sh">'</span><span class="s">fun</span><span class="sh">'</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">svi_butterfly</span><span class="p">,</span>
                 <span class="sh">'</span><span class="s">jac</span><span class="sh">'</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">svi_butterfly_jac</span><span class="p">})</span>
            
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">no_calendar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xv</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">xdata</span><span class="p">.</span><span class="n">values</span>
                <span class="n">xv</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">xv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">xv</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">xv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">param_dic</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">T</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">ti</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">lbl</span><span class="p">])</span>
                <span class="n">ineq_cons</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ineq</span><span class="sh">'</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">fun</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">svi_calendar</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">jac</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">svi_calendar_jac</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">args</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">xv</span><span class="p">),</span>
                <span class="p">})</span>
            
        <span class="k">return</span> <span class="n">ineq_cons</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">svi</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ρ</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">σ</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        SVI parameterisation of the total variance curve 
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span> <span class="n">ρ</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">σ</span><span class="o">**</span><span class="mi">2</span> <span class="p">))</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dsvi</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ρ</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">σ</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        d(SVI)/dk 
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">*</span><span class="n">ρ</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">σ</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">d2svi</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ρ</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">σ</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        d^2(SVI)/dk^2 
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">*</span><span class="n">σ</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">σ</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">q_density</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ρ</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">σ</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span> 
        <span class="sh">"""</span><span class="s">
        Gatheral</span><span class="sh">'</span><span class="s">s risk neutral density function
        </span><span class="sh">"""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ρ</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">σ</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dsvi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">d2w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">d2svi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">dw</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">w</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">((</span><span class="n">dw</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">d2w</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">svi_jac</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ρ</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">σ</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Jacobian of the SVI parameterisation
        </span><span class="sh">"""</span>
        <span class="n">dsda</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">dsdb</span> <span class="o">=</span> <span class="n">ρ</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">((</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">σ</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dsdρ</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span>
        <span class="n">dsdm</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ρ</span><span class="o">+</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">σ</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">dsdσ</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">σ</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">σ</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">dsda</span><span class="p">,</span><span class="n">dsdb</span><span class="p">,</span><span class="n">dsdρ</span><span class="p">,</span><span class="n">dsdm</span><span class="p">,</span><span class="n">dsdσ</span><span class="p">]).</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">svi_mse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Sum of squared errors of the SVI model
        </span><span class="sh">"""</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">ydata</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">svi_mse_jac</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Jacobian of the sum of squared errors
        </span><span class="sh">"""</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi_jac</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">ydata</span><span class="p">).</span><span class="n">T</span><span class="p">.</span><span class="n">values</span><span class="o">*</span><span class="p">(</span><span class="n">jac</span><span class="p">).</span><span class="n">T</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">svi_butterfly</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        SVI butterfly arbitrage constraints (all must be &gt;= 0)
        </span><span class="sh">"""</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ρ</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">σ</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">c4</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">svi_butterfly_jac</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Jacobian of SVI butterfly constraints
        </span><span class="sh">"""</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ρ</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">σ</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">dc1da</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span>
        <span class="n">dc1db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc1dρ</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ρ</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc1dm</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc2da</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span>
        <span class="n">dc2db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc2dρ</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ρ</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc2dm</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">dc3db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">dc3dρ</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ρ</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dc4db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">ρ</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">dc4dρ</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ρ</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dc1dσ</span> <span class="o">=</span> <span class="n">dc2dσ</span> <span class="o">=</span> <span class="n">dc3da</span> <span class="o">=</span> <span class="n">dc3dm</span> <span class="o">=</span> <span class="n">dc3dσ</span> <span class="o">=</span> <span class="n">dc4da</span> <span class="o">=</span> <span class="n">dc4dm</span> <span class="o">=</span> <span class="n">dc4dσ</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">dc1da</span><span class="p">,</span> <span class="n">dc1db</span><span class="p">,</span> <span class="n">dc1dρ</span><span class="p">,</span> <span class="n">dc1dm</span><span class="p">,</span> <span class="n">dc1dσ</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">dc2da</span><span class="p">,</span> <span class="n">dc2db</span><span class="p">,</span> <span class="n">dc2dρ</span><span class="p">,</span> <span class="n">dc2dm</span><span class="p">,</span> <span class="n">dc2dσ</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">dc3da</span><span class="p">,</span> <span class="n">dc3db</span><span class="p">,</span> <span class="n">dc3dρ</span><span class="p">,</span> <span class="n">dc3dm</span><span class="p">,</span> <span class="n">dc3dσ</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">dc4da</span><span class="p">,</span> <span class="n">dc4db</span><span class="p">,</span> <span class="n">dc4dρ</span><span class="p">,</span> <span class="n">dc4dm</span><span class="p">,</span> <span class="n">dc4dσ</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">svi_calendar</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">params_old</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        SVI calendar arbitrage constraint (must be &gt;= 0)
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params_old</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">svi_calendar_jac</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">params_old</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Jacobian of SVI calendar constraint 
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">svi_jac</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        
</code></pre></div></div> <h3 id="an-example-from-crypto">An Example From Crypto</h3> <p>Derivatives trading is still a comparatively nascent market in the digital assets space. The largest crypto options exchange, <a href="https://www.deribit.com/options/BTC" rel="external nofollow noopener" target="_blank">Deribit</a>, allows us with comparative ease to retrieve bid-ask quotes for puts and calls on Bitcoin across a range of strikes and times-to-maturity. The quoting convention is more akin to equity than FX in the sense that strikes are listed in dollar terms, rather than delta. Note though that prices are quoted in units of crypto, reflecting the fact that the options are <a href="https://www.researchgate.net/publication/353478878_Inverse_Options_in_a_Black-Scholes_World" rel="external nofollow noopener" target="_blank">inverse</a> (i.e. have a crypto denominated payoff). Furthermore, crypto being crypto, the implied volatility levels are on average considerably higher (\(\sim\)5x) than the TradFi market.</p> <p>In the example below, I have plotted a bitcoin vol surface which was sampled on 2023-02-16. The lines reflect the SVI fit with ‘no static arbitrage’ constraints enforced. Clearly, the SVI model provides an excellent fit to the volatility surface.</p> <div class="l-page"> <iframe src="/assets/plotly/surface.html" frameborder="0" scrolling="no" height="700px" width="105%" style="border: 1px dashed grey;"></iframe> </div> <p>The above graph was generated using the plotly code below. Being obsessed with certain stylistic elements I admit this is on the longer side:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>

<span class="k">class</span> <span class="nc">SVIPlot</span><span class="p">(</span><span class="n">SVIModel</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">allsmiles</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sv</span><span class="p">:</span> <span class="nf">type</span><span class="p">(</span><span class="n">SVIModel</span><span class="p">)):</span>
        <span class="sh">"""</span><span class="s">
        Plots all volatility smiles in a single 3d figure (data and fit)
        </span><span class="sh">"""</span>

        <span class="n">dfv_dic</span><span class="p">,</span> <span class="n">param_dic</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">sv</span><span class="p">.</span><span class="n">dfv_dic</span><span class="p">,</span> <span class="n">sv</span><span class="p">.</span><span class="n">param_dic</span><span class="p">,</span> <span class="n">sv</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sv</span><span class="p">.</span><span class="n">tau</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">dfv_dic</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="sh">'</span><span class="s">LogM</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">dfv_dic</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="sh">'</span><span class="s">IV</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dfv_dic</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>

            <span class="nf">print</span><span class="p">(</span><span class="n">param_dic</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

            <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span>  <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.1</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="mi">200</span>
            <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span>
            <span class="n">znew</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">svi</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dic</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">/</span><span class="n">tau</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
            <span class="c1">#znew = 100*np.sqrt(self.svi(xnew, param_dic[t]['a'], param_dic[t]['b'], param_dic[t]['ρ'], param_dic[t]['m'], param_dic[t]['σ'])/tau[ti])
</span>            <span class="n">ynew</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">t</span><span class="p">]</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">xnew</span><span class="p">))</span>
            <span class="c1">#ynew[-1] += timedelta(seconds=1)
</span>
            <span class="c1"># See https://plotly.com/python/legend/#grouped-legend-items
</span>            <span class="n">fig</span><span class="p">.</span><span class="nf">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="nc">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">markers</span><span class="sh">'</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y-%m-%d</span><span class="sh">"</span><span class="p">),</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">Black</span><span class="sh">'</span><span class="p">,</span>
                    <span class="c1">#colorscale='PuRd',
</span>                <span class="p">)))</span>
            <span class="n">fig</span><span class="p">.</span><span class="nf">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="nc">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">xnew</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ynew</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">znew</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">lines</span><span class="sh">'</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y-%m-%d</span><span class="sh">"</span><span class="p">),</span> <span class="n">legendgroup</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_change_camera</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_add_onoff</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">.</span><span class="nf">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Volatility Surface</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">.</span><span class="nf">update_scenes</span><span class="p">(</span><span class="n">xaxis_title_text</span><span class="o">=</span><span class="sh">'</span><span class="s">Log Moneyness</span><span class="sh">'</span><span class="p">,</span>
                          <span class="n">yaxis_title_text</span><span class="o">=</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">,</span>
                          <span class="n">zaxis_title_text</span><span class="o">=</span><span class="sh">'</span><span class="s">Implied Volatility</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_change_camera</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">():</span>
        <span class="sh">"""</span><span class="s">
        Adjusts initial view of vol surface
        </span><span class="sh">"""</span>

        <span class="n">fig</span><span class="p">.</span><span class="nf">update_layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
            <span class="n">autosize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span>
                <span class="n">camera</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span>
                    <span class="n">up</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">center</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">eye</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">aspectratio</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span> <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.7</span> <span class="p">),</span>
                <span class="n">aspectmode</span> <span class="o">=</span> <span class="sh">'</span><span class="s">manual</span><span class="sh">'</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_onoff</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">():</span>
        <span class="sh">"""</span><span class="s">
        Add select/deselect all buttons to plot
        </span><span class="sh">"""</span>

        <span class="n">fig</span><span class="p">.</span><span class="nf">update_layout</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">updatemenus</span><span class="o">=</span><span class="p">[</span>
            <span class="nf">dict</span><span class="p">(</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">buttons</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">buttons</span><span class="o">=</span><span class="nf">list</span><span class="p">([</span>
                    <span class="nf">dict</span><span class="p">(</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">visible</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">legendonly</span><span class="sh">"</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Deselect All</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="sh">"</span><span class="s">restyle</span><span class="sh">"</span>
                    <span class="p">),</span>
                    <span class="nf">dict</span><span class="p">(</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">visible</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Select All</span><span class="sh">"</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="sh">"</span><span class="s">restyle</span><span class="sh">"</span>
                    <span class="p">)</span>
                <span class="p">]),</span>
                <span class="n">pad</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">t</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="n">showactive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                <span class="n">yanchor</span><span class="o">=</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></div> <p>And that pretty much wraps it up. As a parting thought, it is interesting to consider whether the SVI surface calibration can be simplified: in particular, can we fit the entire surface in one go, e.g. by postulating explicit \(\tau\)-dependent expressions for the SVI parameters? The advantage of doing so would go beyond pure parsimony: in particular, it would also do away with the non-trivial issue of how one should interpolate between tenors. I’m not the first person to ponder this problem: <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1779463" rel="external nofollow noopener" target="_blank">Gurrieri</a>, for example, takes a decent shot at postulating such expressions. As always, the devil is in the no-arbitrage detail: Gurrieri’s model is arb free, but only under certain tedious constraints. Whether this ultimately is a successful approach remains to be seen.</p> <p>Below I have plotted the calibrated parameters for various times to maturity. On a first inspection some of them seem more prone towards simple parametric fits than others. Are there universal laws for how these parameters should behave? How stable is the SVI fit to perturbations in the parameters? Well, these are open questions. You tell me.</p> <figure> <picture> <img src="/assets/img/svi_param2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Simon Ellersgaard Nielsen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>